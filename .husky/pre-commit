#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."
echo ""

# 1. Lint-staged –¥–ª—è –±—ã—Å—Ç—Ä—ã—Ö –ø—Ä–æ–≤–µ—Ä–æ–∫
echo "üìù Checking code style..."
npx lint-staged || {
  echo "‚ùå Lint-staged failed! Fix formatting issues."
  exit 1
}

# 2. TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞
echo "üî∑ TypeScript check..."
npm run typecheck || {
  echo "‚ùå TypeScript errors found! Fix them before committing."
  exit 1
}

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ—Ç —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ
echo "üîí Checking for secrets in code..."
if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -nH -E '(supabase.*anon.*key.*=.*ey|api.*key.*=.*[A-Z0-9]{20,}|secret.*key|password.*=.*["\x27][^"\x27]{8,})' 2>/dev/null; then
  echo "‚ùå Potential secrets found in code! Use environment variables instead."
  echo "üí° Tip: Move secrets to .env file"
  exit 1
fi

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ .env –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—Å—è
echo "üîê Checking for .env files..."
if git diff --cached --name-only | grep -q "^\\.env$\|^\\.env\\.production$"; then
  echo "‚ùå .env or .env.production files should NOT be committed!"
  echo "üí° These files should be in .gitignore"
  exit 1
fi

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –Ω–µ—Ç console.log –≤ production –∫–æ–¥–µ
echo "üö´ Checking for console.log..."
console_logs=$(git diff --cached --name-only | grep -E '\.(ts|tsx)$' | grep -v '\.test\.' | xargs grep -nH 'console\.log' 2>/dev/null | grep -v '// TODO:' | grep -v '// DEBUG:' || true)
if [ -n "$console_logs" ]; then
  echo "‚ö†Ô∏è  Warning: console.log found in code:"
  echo "$console_logs"
  echo "üí° Consider removing console.log or using logger.debug() instead"
  echo ""
  echo "Continue anyway? (y/n)"
  read -r answer
  if [ "$answer" != "y" ]; then
    exit 1
  fi
fi

echo ""
echo "‚úÖ All pre-commit checks passed!"
echo ""
